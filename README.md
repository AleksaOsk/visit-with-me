# Time Together

## О проекте

Time Together – это сервис для организации событий, где пользователи могут:

* Публиковать мероприятия
* Находить интересные события в своем городе
* Подавать заявки на участие
* Оставлять комментарии к событиям и подборкам

Ключевые особенности:

* Система автоматически определяет популярные мероприятия на основе статистики просмотров
* Топовые события выводятся в начале списков
* Расширенный функционал для администраторов

Возможности администраторов:

* Модерация контента
* Управление пользователями
* Создание тематических подборок мероприятий
* Управление категориями событий

## Архитектура проекта

Решение состоит из двух независимых модулей:

* Основной сервер (`ewm-service`)
    * Работа с пользователями и событиями
    * Обработка заявок на участие
    * Управление подборками и комментариями
    * REST API для клиентов
* Статистический модуль (`stats`)
    * Сбор данных о просмотрах
    * Анализ популярности событий
    * Предоставление статистики для основного сервиса

Принципы взаимодействия:

* Каждый сервис использует отдельную БД (PostgreSQL)
* Обмен данными через REST API
* Контейнеризация с помощью Docker

## Стек технологий

**Backend:**

* Java 21
* Spring Boot
* Spring Data JPA
* Hibernate (ORM)
* Lombok
* SLF4J (логирование)

**Базы данных:**

* PostgreSQL 16 (основная БД)
* H2 (для тестирования)

**Тестирование:**

* JUnit 5
* Mockito
* Spring Boot Test

**Инфраструктура:**

* Docker
* Docker Compose

**Инструменты разработки:**

* Maven (сборка проекта)
* Postman (тестирование API)
* DBeaver (работа с БД)
* IntelliJ IDEA (IDE)

## Структура проекта

Проект состоит из двух основных модулей:

Основной сервис (**ewm-main-service**)\
Отвечает за:

* Регистрацию и управление пользователями
* Полный цикл работы с событиями:
    * Создание и редактирование
    * Модерация
    * Поиск и фильтрация
* Обработку заявок на участие
* Управление подборками мероприятий
* Систему комментариев

Статистический модуль (**stats**)\
Состоит из 3 подмодулей:

1. **stats-server**:
    * Принимает данные о просмотрах
    * Хранит статистику
    * Предоставляет API для аналитики
2. **stats-client**:
    * Отправляет данные о просмотрах
    * Интегрирован с основным сервисом
3. **stats-dto**:
    * Общие DTO для передачи данных
    * Валидация запросов

## Базы данных

Основная база данных (ewm-service)

![image](https://github.com/user-attachments/assets/9d829698-ca75-40b1-bf21-72da7e232283)

Основные таблицы:

* `users` - зарегистрированные пользователи
* `events` - мероприятия
* `categories` - категории событий
* `compilations` - подборки мероприятий
* `event_requests` - заявки на участие
* `comments` - комментарии пользователей
* `event_compilation` - события в подборках

База данных статистики (stats)

![image](https://github.com/user-attachments/assets/3127f07f-24f0-448b-8483-4179c05e9f7b)

Таблица hits содержит:

* ID записи
* Название сервиса (app)
* URI просмотренной страницы
* IP-адрес пользователя
* Временную метку просмотра

## Функциональность

API сервиса разделено на три группы:

* **Public API** — доступно без авторизации
* **Private API** — требует авторизации пользователя
* **Admin API** — только для администраторов

### User API (Admin only)

`POST /admin/users` - создание нового пользователя\
`GET /admin/users` - получение списка пользователей (с фильтрацией по IDs)\
`DELETE /admin/users/{userId}` - удаление пользователя по ID

### Event API

**Public:**\
`GET /events` - получение опубликованных событий\
`GET /events/{id} `- получение конкретного опубликованного события (+ запись статистики)

**Private:**\
`POST /users/{userId}/events` - создание нового события\
`PATCH /users/{userId}/events/{eventId}` - обновление своего события\
`GET /users/{userId}/events` - получение своих событий\
`GET /users/{userId}/events/{eventId}/requests` - список запросов на участие в своём событии

**Admin:**\
`GET /admin/events` - получение всех событий (с фильтрацией)\
`PUT /admin/events/{eventId}` - изменение события (модерация)

### Category API

**Public:**\
`GET /categories` - получение всех категорий (с пагинацией)\
`GET /categories/{catId}` - получение конкретной категории

**Admin:**\
`POST /admin/categories` - добавление новой категории\
`PATCH /admin/categories/{catId}` - обновление категории\
`DELETE /admin/categories/{catId}` - удаление категории

### Participation Request API (Private only)

`POST /users/{userId}/requests` - подача заявки на участие в событии\
`PATCH /users/{userId}/requests/{requestId}/cancel` - отмена своей заявки\
`GET /users/{userId}/requests` - получение своих заявок

### Compilation API

**Public:**\
`GET /compilations` - получение всех подборок\
`GET /compilations/{compId}` - получение конкретной подборки (+ запись статистики)

**Admin:**\
`POST /admin/compilations` - создание новой подборки\
`PATCH /admin/compilations/{compId}` - обновление подборки\
`DELETE /admin/compilations/{compId}` - удаление подборки

### Comment API (Private only)

`POST /users/{userId}/comments/events/{eventId}` - добавление комментария событию\
`POST /users/{userId}/comments/compilation/{compId}` - добавление комментария подборке\
`PATCH /users/{userId}/comments/{commentId}` - обновление своего комментария\
`DELETE /users/{userId}/comments/{commentId}` - удаление своего комментария

## Система учета статистики и популярности

При получении конкретного события (`GET /events/{id}`) или подборки (`GET /compilations/{compId}`) автоматически:

1. Отправляется POST-запрос в сервис статистики (`/stats/hit`) с данными:
    * `uri` – путь запроса (например, `/events/42`)
    * `ip` – IP-адрес пользователя
    * `timestamp` – время просмотра
2. Данные сохраняются в БД статистики (таблица `hits`).
3. При последующих запросах (`GET /events`, `GET /compilations`) учитывается количество просмотров для:
    * Сортировки по популярности (топовые события выводятся первыми)
    * Фильтрации (например, "только популярные")
